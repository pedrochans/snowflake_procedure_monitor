<!DOCTYPE html>
<html class="dark" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Snowflake Monitor</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#00F0FF",
                        "background-dark": "#050a14",
                        "surface-dark": "#0f1623",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"]
                    },
                    backgroundImage: {
                        'pixel-grid': 'linear-gradient(to right, rgba(0, 240, 255, 0.05) 1px, transparent 1px), linear-gradient(to bottom, rgba(0, 240, 255, 0.05) 1px, transparent 1px)'
                    }
                },
            },
        }
    </script>
    <style>
        .pixel-shadow { box-shadow: 4px 4px 0px 0px rgba(0, 240, 255, 0.2); }
        .text-glow { text-shadow: 0 0 20px rgba(0, 240, 255, 0.6); }
        .crt-line {
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 4px, 6px 100%;
        }
        .log-container { scrollbar-width: thin; scrollbar-color: #00F0FF30 transparent; }
        .log-container::-webkit-scrollbar { width: 6px; }
        .log-container::-webkit-scrollbar-track { background: transparent; }
        .log-container::-webkit-scrollbar-thumb { background: #00F0FF30; border-radius: 3px; }
        @keyframes pulse-glow { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
        /* Disable text selection for app-like feel */
        body { user-select: none; -webkit-user-select: none; }
        .log-message { user-select: text; -webkit-user-select: text; }
    </style>
</head>
<body class="bg-background-dark font-display text-white h-screen flex flex-col overflow-hidden relative">
    <!-- Background effects -->
    <div class="absolute inset-0 bg-pixel-grid bg-[size:40px_40px] pointer-events-none z-0"></div>
    <div class="absolute inset-0 crt-line pointer-events-none z-10 opacity-20 mix-blend-overlay"></div>

    <!-- Main content -->
    <main class="relative z-20 flex-1 flex flex-col items-center w-full max-w-5xl mx-auto px-6 py-6 overflow-y-auto min-h-0">
        <!-- Status badge (top right) -->
        <div class="absolute top-2 right-2 z-30">
            <div id="status-badge" class="flex h-8 items-center justify-center gap-x-2 rounded bg-surface-dark border border-white/5 pl-2 pr-4 shadow-sm">
                <span id="status-dot" class="material-symbols-outlined text-gray-400 text-[18px]">radio_button_checked</span>
                <p id="status-text" class="text-white text-xs font-mono font-medium tracking-wide uppercase">Offline</p>
            </div>
        </div>

        <!-- Status display -->
        <div class="flex flex-col items-center justify-center w-full mb-4 flex-shrink-0">
            <div class="flex items-center gap-4">
                <h2 id="main-status" class="text-4xl md:text-6xl lg:text-7xl font-bold text-gray-500 tracking-tighter mb-2 select-none transition-all duration-500">Stopped</h2>
                <div id="loading-indicator" class="hidden grid grid-cols-3 gap-0.5 w-6 h-6 mt-2 opacity-80 animate-pulse">
                    <div class="bg-primary"></div><div class="bg-transparent"></div><div class="bg-primary"></div>
                    <div class="bg-transparent"></div><div class="bg-primary"></div><div class="bg-transparent"></div>
                    <div class="bg-primary"></div><div class="bg-transparent"></div><div class="bg-primary"></div>
                </div>
            </div>
            <!-- Subtitle with uptime inline -->
            <div class="flex items-center gap-4 mb-4">
                <p id="status-description" class="text-slate-400 text-base font-normal text-center tracking-wide">
                    Monitor is not running. Click Start to begin monitoring.
                </p>
                <div id="uptime-container" class="hidden flex items-center gap-2 text-sm border-l border-white/10 pl-4">
                    <span class="text-white/40 text-xs font-mono uppercase">Uptime:</span>
                    <span id="uptime-value" class="text-white font-mono">--</span>
                </div>
            </div>
        </div>

        <!-- Log terminal -->
        <div class="w-full max-w-3xl rounded-lg bg-[#0a0f18] border border-white/10 shadow-2xl overflow-hidden flex flex-col flex-1 min-h-0">
            <div class="flex items-center justify-between px-4 py-2 bg-white/5 border-b border-white/5 flex-shrink-0">
                <div class="flex gap-2">
                    <div class="size-3 rounded-full bg-red-500/80"></div>
                    <div class="size-3 rounded-full bg-yellow-500/80"></div>
                    <div class="size-3 rounded-full bg-green-500/80"></div>
                </div>
                <div class="text-xs text-white/30 font-mono">snowflake-monitor logs</div>
                <button onclick="clearLogs()" class="text-white/30 hover:text-white/60 transition-colors" title="Clear logs">
                    <span class="material-symbols-outlined text-[16px]">delete</span>
                </button>
            </div>
            <div id="log-container" class="log-container p-3 font-mono text-xs overflow-y-auto flex flex-col gap-1 flex-1">
                <div class="text-white/30 text-center py-8">
                    <span class="material-symbols-outlined text-4xl mb-2 block">terminal</span>
                    No logs available. Start the monitor to see activity.
                </div>
            </div>
        </div>
    </main>

    <!-- Footer with controls -->
    <footer class="relative z-20 w-full px-6 py-4 pb-8 flex-shrink-0">
        <div class="max-w-5xl mx-auto flex flex-col sm:flex-row items-center justify-center gap-3">
            <button id="btn-start" onclick="startMonitor()" class="group flex h-11 items-center justify-center gap-2 rounded px-6 bg-green-500/20 border border-green-500/50 text-green-400 hover:bg-green-500 hover:text-background-dark transition-all pixel-shadow disabled:opacity-50 disabled:cursor-not-allowed">
                <span class="material-symbols-outlined text-[20px]">play_arrow</span>
                <span class="text-sm font-bold">Start Monitor</span>
            </button>
            <button id="btn-stop" onclick="stopMonitor()" disabled class="group flex h-11 items-center justify-center gap-2 rounded px-6 bg-red-500/10 border border-red-500/30 text-red-400 hover:bg-red-500 hover:text-white transition-all pixel-shadow disabled:opacity-30 disabled:cursor-not-allowed">
                <span class="material-symbols-outlined text-[20px]">stop_circle</span>
                <span class="text-sm font-bold">Stop Monitor</span>
            </button>
            <button id="btn-restart" onclick="restartMonitor()" disabled class="group flex h-11 items-center justify-center gap-2 rounded px-6 border border-white/10 bg-transparent text-white hover:bg-white/5 hover:border-white/20 transition-all disabled:opacity-30 disabled:cursor-not-allowed">
                <span class="material-symbols-outlined text-[20px]">restart_alt</span>
                <span class="text-sm font-bold">Restart</span>
            </button>
        </div>
    </footer>

    <script>
        // State
        let isRunning = false;
        let pollingInterval = null;
        let logsInterval = null;

        // DOM elements
        const mainStatus = document.getElementById('main-status');
        const statusDescription = document.getElementById('status-description');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const loadingIndicator = document.getElementById('loading-indicator');
        const uptimeContainer = document.getElementById('uptime-container');
        const uptimeValue = document.getElementById('uptime-value');
        const logContainer = document.getElementById('log-container');
        const btnStart = document.getElementById('btn-start');
        const btnStop = document.getElementById('btn-stop');
        const btnRestart = document.getElementById('btn-restart');

        // Wait for pywebview API to be ready
        window.addEventListener('pywebviewready', function() {
            console.log('PyWebView API ready');
            initApp();
        });

        // Fallback for browser testing (without pywebview)
        setTimeout(() => {
            if (typeof pywebview === 'undefined') {
                console.log('Running in browser mode (no pywebview)');
                // Create mock API for browser testing
                window.pywebview = {
                    api: {
                        get_status: async () => ({ status: 'stopped', uptime: null }),
                        get_logs: async () => ({ logs: [] }),
                        start_monitor: async () => ({ success: true, message: 'Mock start' }),
                        stop_monitor: async () => ({ success: true, message: 'Mock stop' }),
                        restart_monitor: async () => ({ success: true, message: 'Mock restart' })
                    }
                };
                initApp();
            }
        }, 1000);

        function initApp() {
            fetchStatus();
            fetchLogs();
            // Poll status and logs
            pollingInterval = setInterval(fetchStatus, 3000);
            logsInterval = setInterval(fetchLogs, 2000);
        }

        // Fetch current status from Python
        async function fetchStatus() {
            try {
                const data = await pywebview.api.get_status();
                updateUI(data.status, data.uptime);
            } catch (error) {
                console.error('Error fetching status:', error);
            }
        }

        // Fetch logs from Python
        async function fetchLogs() {
            try {
                const data = await pywebview.api.get_logs(150);
                updateLogs(data.logs);
            } catch (error) {
                console.error('Error fetching logs:', error);
            }
        }

        // Update UI based on status
        function updateUI(status, uptime) {
            isRunning = status === 'running';
            
            if (status === 'running') {
                mainStatus.textContent = 'Running...';
                mainStatus.className = 'text-4xl md:text-6xl lg:text-7xl font-bold text-primary tracking-tighter text-glow mb-2 select-none transition-all duration-500';
                statusDescription.textContent = 'Monitoring active Snowflake Procedures';
                statusDot.className = 'material-symbols-outlined text-green-400 text-[18px] animate-pulse-glow';
                statusText.textContent = 'Live';
                loadingIndicator.classList.remove('hidden');
                uptimeContainer.classList.remove('hidden');
                uptimeContainer.classList.add('flex');
                uptimeValue.textContent = uptime || '--';
                
                btnStart.disabled = true;
                btnStop.disabled = false;
                btnRestart.disabled = false;
            } else if (status === 'starting') {
                mainStatus.textContent = 'Starting...';
                mainStatus.className = 'text-4xl md:text-6xl lg:text-7xl font-bold text-yellow-500 tracking-tighter text-glow mb-2 select-none transition-all duration-500';
                statusDescription.textContent = 'Connecting to Snowflake... Please complete authentication if prompted.';
                statusDot.className = 'material-symbols-outlined text-yellow-400 text-[18px] animate-pulse-glow';
                statusText.textContent = 'Starting';
                loadingIndicator.classList.remove('hidden');
                uptimeContainer.classList.add('hidden');
                uptimeContainer.classList.remove('flex');
                
                btnStart.disabled = true;
                btnStop.disabled = false;
                btnRestart.disabled = true;
            } else if (status === 'error') {
                mainStatus.textContent = 'Error';
                mainStatus.className = 'text-4xl md:text-6xl lg:text-7xl font-bold text-red-500 tracking-tighter mb-2 select-none transition-all duration-500';
                statusDescription.textContent = 'An error occurred. Check the logs for details.';
                statusDot.className = 'material-symbols-outlined text-red-400 text-[18px]';
                statusText.textContent = 'Error';
                loadingIndicator.classList.add('hidden');
                uptimeContainer.classList.add('hidden');
                uptimeContainer.classList.remove('flex');
                
                btnStart.disabled = false;
                btnStop.disabled = true;
                btnRestart.disabled = true;
            } else {
                mainStatus.textContent = 'Stopped';
                mainStatus.className = 'text-4xl md:text-6xl lg:text-7xl font-bold text-gray-500 tracking-tighter mb-2 select-none transition-all duration-500';
                statusDescription.textContent = 'Monitor is not running. Click Start to begin monitoring.';
                statusDot.className = 'material-symbols-outlined text-gray-400 text-[18px]';
                statusText.textContent = 'Offline';
                loadingIndicator.classList.add('hidden');
                uptimeContainer.classList.add('hidden');
                uptimeContainer.classList.remove('flex');
                
                btnStart.disabled = false;
                btnStop.disabled = true;
                btnRestart.disabled = true;
            }
        }

        // Update logs display
        function updateLogs(logs) {
            if (!logs || logs.length === 0) {
                logContainer.innerHTML = `
                    <div class="text-white/30 text-center py-8">
                        <span class="material-symbols-outlined text-4xl mb-2 block">terminal</span>
                        No logs available. Start the monitor to see activity.
                    </div>
                `;
                return;
            }

            const wasScrolledToBottom = logContainer.scrollHeight - logContainer.clientHeight <= logContainer.scrollTop + 50;
            
            logContainer.innerHTML = logs.map(log => {
                const levelClass = getLevelClass(log.level);
                const timestamp = log.timestamp ? log.timestamp.split(',')[0].split(' ')[1] || log.timestamp : '';
                return `
                    <div class="flex gap-2 text-white/70 hover:text-white/90 hover:bg-white/5 px-1 rounded transition-colors">
                        <span class="opacity-50 text-[10px] w-16 flex-shrink-0">[${timestamp}]</span>
                        <span class="${levelClass} text-[10px] font-medium w-14 flex-shrink-0">${log.level}</span>
                        <span class="flex-1 log-message break-all">${escapeHtml(log.message)}</span>
                    </div>
                `;
            }).join('');

            // Auto-scroll to bottom if was already at bottom
            if (wasScrolledToBottom) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        // Get CSS class for log level
        function getLevelClass(level) {
            switch (level?.toUpperCase()) {
                case 'ERROR': return 'text-red-400';
                case 'WARNING':
                case 'WARN': return 'text-yellow-400';
                case 'SUCCESS': return 'text-green-400';
                case 'DEBUG': return 'text-purple-400';
                default: return 'text-blue-400';
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Start monitor
        async function startMonitor() {
            btnStart.disabled = true;
            
            try {
                const data = await pywebview.api.start_monitor();
                if (data.success) {
                    // Immediately fetch status to show "starting" state
                    fetchStatus();
                    setTimeout(fetchLogs, 1000);
                } else {
                    alert('Error: ' + data.message);
                    fetchStatus();
                }
            } catch (error) {
                console.error('Error starting monitor:', error);
                alert('Failed to start monitor: ' + error);
                fetchStatus();
            }
        }

        // Stop monitor
        async function stopMonitor() {
            btnStop.disabled = true;
            mainStatus.textContent = 'Stopping...';
            mainStatus.className = 'text-4xl md:text-6xl lg:text-7xl font-bold text-yellow-500 tracking-tighter mb-2 select-none transition-all duration-500';
            statusDot.className = 'material-symbols-outlined text-yellow-400 text-[18px] animate-pulse-glow';
            statusText.textContent = 'Stopping';
            
            try {
                const data = await pywebview.api.stop_monitor();
                setTimeout(fetchStatus, 1000);
            } catch (error) {
                console.error('Error stopping monitor:', error);
                alert('Failed to stop monitor: ' + error);
                fetchStatus();
            }
        }

        // Restart monitor
        async function restartMonitor() {
            btnRestart.disabled = true;
            mainStatus.textContent = 'Restarting...';
            mainStatus.className = 'text-4xl md:text-6xl lg:text-7xl font-bold text-yellow-500 tracking-tighter mb-2 select-none transition-all duration-500';
            statusDot.className = 'material-symbols-outlined text-yellow-400 text-[18px] animate-pulse-glow';
            statusText.textContent = 'Restarting';
            
            try {
                const data = await pywebview.api.restart_monitor();
                setTimeout(fetchStatus, 1000);
                setTimeout(fetchLogs, 1500);
            } catch (error) {
                console.error('Error restarting monitor:', error);
                alert('Failed to restart monitor: ' + error);
                fetchStatus();
            }
        }

        // Clear logs display (visual only)
        function clearLogs() {
            logContainer.innerHTML = `
                <div class="text-white/30 text-center py-8">
                    <span class="material-symbols-outlined text-4xl mb-2 block">terminal</span>
                    Logs cleared. New logs will appear shortly.
                </div>
            `;
        }
    </script>
</body>
</html>
